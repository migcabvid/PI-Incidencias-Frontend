<!-- src/app/components/misIncidencias/misIncidencias.component.html -->
<main class="container py-3">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <!-- Título dentro de la misma caja -->
        <div class="titulo-formulario">
          Lista de Incidencias
        </div>
        <div class="card-body">

          <ng-container *ngIf="activeRole === 'coordinadortic' || activeRole === 'equipodirectivo'">
            <!-- Filtros: Fecha Desde, Fecha Hasta, Botón Buscar -->
            <form class="row g-3 mb-4 align-items-end">
              <div class="col-md-5">
                <label for="from" class="form-label">Fecha Desde</label>
                <div class="input-group">
                  <input #from type="date" id="from" class="form-control">
                  <span class="input-group-text bg-white">
                    <i class="bi bi-calendar-event"></i>
                  </span>
                </div>
              </div>
              <div class="col-md-5">
                <label for="to" class="form-label">Fecha Hasta</label>
                <div class="input-group">
                  <input #to type="date" id="to" class="form-control">
                  <span class="input-group-text bg-white">
                    <i class="bi bi-calendar-event"></i>
                  </span>
                </div>
              </div>
              <div class="col-md-2 d-grid">
                <button type="button" class="btn btn-success" (click)="filterByDate(from, to)">
                  <i class="bi bi-search me-1"></i>Buscar
                </button>
              </div>
            </form>

            <!-- Tabla de Resumen: Agrupada por estado -->
            <div *ngIf="summaryData.length > 0" class="table-responsive rounded-3 border mb-4"
              style="width: 70%; margin: 0 auto;">
              <table class="table incidents-table text-center " style="margin: 0px;">
                <thead>
                  <tr>
                    <th>Incidencias</th>
                    <th>Número</th>
                    <th>Acción</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let s of summaryData">
                    <td>{{ s.type }}</td>
                    <td>{{ s.count }}</td>
                    <td>
                      <!-- Botón “+” (muestra la tabla original filtrada por estado) -->
                      <button class="btn btn-sm btn-success me-1" (click)="showByEstado(s.type)"
                        title="Ver detalles de '{{ s.type }}'">
                        <i class="bi bi-plus-lg"></i>
                      </button>
                      <!-- Botón de “PDF” (puedes implementar generación de PDF aquí) -->
                      <button class="btn btn-sm btn-success me-1" title="Generar PDF">
                        <i class="bi bi-filetype-pdf"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </ng-container>

          <!-- BUSCADOR por ID-->
          <div class="row g-3 mb-4">
            <div class="col-md-12">
              <label for="searchId" class="form-label">Buscar ID</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input #searchId type="text" id="searchId" class="form-control" placeholder="Escribe el ID..."
                  (input)="filtrarPorId(searchId.value)" />
              </div>
            </div>
          </div>

          <!-- INDICADOR DE CARGA -->
          <div class="d-flex justify-content-center align-items-center" style="height: 200px;" *ngIf="estaCargando">
            <div class="spinner-border text-success" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
          </div>

          <!-- TABLA de Incidencias -->
          <div *ngIf="!estaCargando">
            <div class="table-responsive rounded-3 border">
              <table class="table align-middle incidents-table mb-0">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Descripción</th>
                    <th>Fecha</th>

                    <!-- Estado solo para profesor -->
                    <th *ngIf="activeRole === 'profesor'">Estado</th>

                    <!-- Profesor para coordinador & equipo directivo -->
                    <th *ngIf="activeRole === 'coordinadortic' || activeRole === 'equipodirectivo'">
                      Profesor
                    </th>

                    <th class="text-center">Acción</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let inc of incidenciasPagina">
                    <td>{{ inc.idIncidencia }}</td>
                    <td>{{ inc.descripcion }}</td>
                    <td>{{ inc.fechaIncidencia | date:'yyyy-MM-dd' }}</td>

                    <!-- Celda Estado (solo para profesor) -->
                    <td *ngIf="activeRole === 'profesor'">
                      {{ inc.estado }}
                    </td>

                    <!-- Celda DNI Profesor (para coordinador o equipo directivo) -->
                    <td *ngIf="activeRole === 'coordinadortic' || activeRole === 'equipodirectivo'">
                      {{ inc.dniProfesor }}
                    </td>

                    <td class="text-center">
                      <!-- Botones individuales (≥ sm) -->
                      <div class="d-none d-sm-inline-flex gap-1">
                        <button class="btn btn-success btn-sm" (click)="abrirModalDetalle(inc)" title="Ver detalles">
                          <i class="bi bi-plus"></i>
                        </button>
                        <button class="dropdown-item bg-success text-white" (click)="abrirModalDetalle(inc)" title="Solucionar">
                          <i class="bi bi-trash me-2"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" (click)="abrirModalEliminar(inc)" title="Eliminar">
                          <i class="bi bi-trash-fill text-white"></i>
                        </button>
                      </div>

                      <!-- Dropdown de acciones (< sm) -->
                      <div class="dropdown d-inline-block d-sm-none">
                        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button"
                          id="dropdownAcciones{{ inc.idIncidencia }}" data-bs-toggle="dropdown" aria-expanded="false"
                          title="Acciones">
                          <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end"
                          [attr.aria-labelledby]="'dropdownAcciones' + inc.idIncidencia">
                          <li>
                            <button class="dropdown-item bg-success text-white" (click)="abrirModalDetalle(inc)">
                              <i class="bi bi-plus me-2"></i>
                              Ver detalles
                            </button>
                          </li>
                          <li>
                            <button class="dropdown-item bg-success text-white" (click)="abrirModalDetalle(inc)">
                              <i class="bi bi-trash me-2"></i>
                              Solucionar
                            </button>
                          </li>
                          <li>
                            <button class="dropdown-item bg-danger text-white" (click)="abrirModalEliminar(inc)">
                              <i class="bi bi-trash me-2"></i>
                              Eliminar
                            </button>
                          </li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Paginación de Bootstrap -->
            <nav aria-label="Paginación de incidencias" class="mt-3">
              <ul class="pagination justify-content-center mb-0">
                <!-- Botón “Anterior” -->
                <li class="page-item" [class.disabled]="paginaActual === 1">
                  <button class="page-link border-success text-success" [class.bg-success]="paginaActual === 1"
                    [class.text-white]="paginaActual === 1" (click)="irAPagina(paginaActual - 1)"
                    [attr.disabled]="paginaActual === 1 ? true : null">
                    <span aria-hidden="true">&laquo;</span>
                  </button>
                </li>
                <!-- Números de página -->
                <li class="page-item" *ngFor="let _ of [].constructor(totalPaginas); let i = index"
                  [class.active]="paginaActual === i + 1">
                  <button class="page-link" [class.border-success]="paginaActual !== (i + 1)"
                    [class.text-success]="paginaActual !== (i + 1)" [class.bg-success]="paginaActual === (i + 1)"
                    [class.text-white]="paginaActual === (i + 1)" (click)="irAPagina(i + 1)">
                    {{ i + 1 }}
                  </button>
                </li>
                <!-- Botón “Siguiente” -->
                <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
                  <button class="page-link border-success text-success"
                    [class.bg-success]="paginaActual === totalPaginas"
                    [class.text-white]="paginaActual === totalPaginas" (click)="irAPagina(paginaActual + 1)"
                    [attr.disabled]="paginaActual === totalPaginas ? true : null">
                    <span aria-hidden="true">&raquo;</span>
                  </button>
                </li>
              </ul>
            </nav>
          </div>

        </div>
      </div>
    </div>
  </div>
</main>

<!-- Modal confirmación de eliminación -->
<div class="modal fade show d-block custom-modal-backdrop" tabindex="-1" *ngIf="mostrarModalEliminar"
  (click)="cerrarModalEliminar()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content custom-modal-content">
      <div class="modal-header custom-modal-header">
        <h5 class="modal-title flex-grow-1 text-center">Eliminación</h5>
      </div>
      <div class="modal-body text-center custom-modal-body">
        ¿Desea eliminar?
      </div>
      <div class="modal-footer border-0 justify-content-center">
        <button type="button" class="btn btn-success me-2" (click)="confirmarEliminacion()">
          <i class="bi bi-check-circle-fill me-1"></i> Aceptar
        </button>
        <button type="button" class="btn btn-danger" (click)="cerrarModalEliminar()">
          <i class="bi bi-x-circle-fill me-1"></i> Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de eliminación exitosa -->
<div class="modal fade show d-block custom-modal-backdrop" tabindex="-1" *ngIf="mostrarModalExito"
  (click)="mostrarModalExito = false">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content custom-modal-content">
      <div class="modal-header custom-modal-header">
        <h5 class="modal-title flex-grow-1 text-center">Eliminación</h5>
        <button type="button" class="btn-close custom-btn-close" aria-label="Cerrar"
          (click)="mostrarModalExito = false">
          <i class="bi bi-x-circle-fill"></i>
        </button>
      </div>
      <div class="modal-body text-center custom-modal-body">
        Eliminado correctamente.
      </div>
    </div>
  </div>
</div>

<!-- Modal de detalles de incidencia -->
<div class="modal fade show d-block custom-modal-backdrop" tabindex="-1" *ngIf="mostrarModalDetalle"
  (click)="cerrarModalDetalle()">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
    <div class="modal-content custom-modal-content">
      <div class="modal-header custom-modal-header">
        <h5 class="modal-title flex-grow-1 text-center">Detalles de la Incidencia</h5>
        <button type="button" class="btn-close custom-btn-close" aria-label="Cerrar" (click)="cerrarModalDetalle()">
          <i class="bi bi-x-circle-fill"></i>
        </button>
      </div>
      <div class="modal-body custom-modal-body">
        <div *ngIf="incidenciaDetalle">
          <p><strong>ID:</strong> {{ incidenciaDetalle.idIncidencia }}</p>
          <p><strong>Fecha:</strong> {{ incidenciaDetalle.fechaIncidencia | date:'yyyy-MM-dd' }}</p>
          <p><strong>Tipo:</strong> {{ incidenciaDetalle.tipoIncidencia }}</p>
          <p><strong>Descripción:</strong> {{ incidenciaDetalle.descripcion }}</p>
          <p><strong>DNI Profesor:</strong> {{ incidenciaDetalle.dniProfesor }}</p>
          <p><strong>Estado:</strong> {{ incidenciaDetalle.estado }}</p>
          <ng-container *ngIf="incidenciaDetalle.foto">
            <p><strong>Foto:</strong></p>
            <img [src]="'data:image/jpeg;base64,' + incidenciaDetalle.foto" alt="Foto de la incidencia" style="
                   max-width: 100%;
                   max-height: 250px;
                   object-fit: contain;
                   border-radius: 0.5rem;
                   border: 1px solid #ccc;
                 " />
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>
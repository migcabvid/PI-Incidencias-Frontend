<main class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card shadow-sm">
        <div class="titulo-formulario">
          Lista de Incidencias
        </div>
        <div class="card-body">

          <!-- Filtros: Fecha Desde, Fecha Hasta, Botón Buscar -->
          <form class="row g-3 mb-4 align-items-end">
            <div class="col-md-5">
              <label for="from" class="form-label">Fecha Desde</label>
              <div class="input-group">
                <input #from type="date" id="from" class="form-control">
                <span class="input-group-text bg-white">
                  <i class="bi bi-calendar-event"></i>
                </span>
              </div>
            </div>
            <div class="col-md-5">
              <label for="to" class="form-label">Fecha Hasta</label>
              <div class="input-group">
                <input #to type="date" id="to" class="form-control">
                <span class="input-group-text bg-white">
                  <i class="bi bi-calendar-event"></i>
                </span>
              </div>
            </div>
            <div class="col-md-2 d-grid">
              <button type="button" class="btn btn-success" (click)="filterByDate(from, to)">
                <i class="bi bi-search me-1"></i>Buscar
              </button>
            </div>
          </form>

          <!-- Tabla de Resumen (centrada y con ancho máximo) -->
          <div class="table-responsive mb-4 mx-auto summary-wrap">
            <table class="table text-center mb-0 summary-table">
              <thead>
                <tr>
                  <th>Incidencias</th>
                  <th>Número</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let s of summaryData">
                  <td>{{ s.type }}</td>
                  <td>{{ s.count }}</td>
                  <td>
                    <button class="btn btn-sm btn-success me-1">
                      <i class="bi bi-plus-lg"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary">
                      <i class="bi bi-filetype-pdf"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Buscador por ID -->
          <div class="row mb-4">
            <div class="col-md-4">
              <label for="searchId" class="form-label">Buscar ID</label>
              <div class="input-group">
                <span class="input-group-text bg-white">
                  <i class="bi bi-search"></i>
                </span>
                <input #searchId type="text" id="searchId" class="form-control" placeholder="Escribe el ID..."
                  (input)="filterById(searchId.value)" />
              </div>
            </div>
          </div>

          <!-- Tabla principal de incidencias -->
          <div class="table-responsive">
            <table class="table align-middle mb-0 incidents-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Descripción</th>
                  <th>Fecha</th>
                  <th>Profesor</th>
                  <th class="text-center">Acción</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let inc of filteredIncidents">
                  <td>{{ inc.idIncidencia }}</td>
                  <td>{{ inc.descripcion }}</td>
                  <td>{{ inc.fechaIncidencia | date:'yyyy-MM-dd' }}</td>
                  <td>{{ inc.dniProfesor }}</td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-success me-1" (click)="openDetailModal(inc)">
                      <i class="bi bi-plus-lg"></i>
                    </button>
                    <button class="btn btn-primary btn-sm" (click)="abrirModalSolucion(inc)">
                      <i class="bi bi-check2"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" (click)="openDeleteModal(inc)">
                      <i class="bi bi-trash-fill"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Modal de detalles -->
          <div class="modal fade show d-block custom-modal-backdrop" tabindex="-1" *ngIf="showDetailModal">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content custom-modal-content">
                <div class="modal-header custom-modal-header">
                  <h5 class="modal-title flex-grow-1 text-center">
                    Detalles de la Incidencia
                  </h5>
                  <button type="button" class="btn-close custom-btn-close" aria-label="Cerrar"
                    (click)="closeDetailModal()">
                    <i class="bi bi-x-circle-fill"></i>
                  </button>
                </div>
                <div class="modal-body custom-modal-body">
                  <div *ngIf="incidenciaDetalle">
                    <p><strong>ID:</strong> {{ incidenciaDetalle.idIncidencia }}</p>
                    <p><strong>Fecha:</strong> {{ incidenciaDetalle.fechaIncidencia | date:'yyyy-MM-dd' }}</p>
                    <p><strong>Tipo:</strong> {{ incidenciaDetalle.tipoIncidencia }}</p>
                    <p><strong>Descripción:</strong> {{ incidenciaDetalle.descripcion }}</p>
                    <p><strong>DNI Profesor:</strong> {{ incidenciaDetalle.dniProfesor }}</p>
                    <p><strong>Estado:</strong> {{ incidenciaDetalle.estado }}</p>
                    <ng-container *ngIf="incidenciaDetalle.foto">
                      <p><strong>Foto:</strong></p>
                      <img [src]="'data:image/jpeg;base64,' + incidenciaDetalle.foto" alt="Foto de la incidencia"
                        style="max-width: 100%; max-height: 250px; object-fit: contain; border-radius: 0.5rem; border: 1px solid #ccc;" />
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal confirmación de eliminación -->
          <div class="modal fade show d-block custom-modal-backdrop" tabindex="-1" *ngIf="showModal">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content custom-modal-content">
                <div class="modal-header custom-modal-header">
                  <h5 class="modal-title flex-grow-1 text-center">
                    Eliminación
                  </h5>
                </div>
                <div class="modal-body text-center custom-modal-body">
                  ¿Desea eliminar?
                </div>
                <div class="modal-footer border-0 justify-content-center">
                  <button type="button" class="btn btn-success me-2" (click)="confirmDelete()">
                    <i class="bi bi-check-circle-fill me-1"></i> Aceptar
                  </button>
                  <button type="button" class="btn btn-danger" (click)="closeModal()">
                    <i class="bi bi-x-circle-fill me-1"></i> Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de eliminación exitosa -->
          <div class="modal fade show d-block custom-modal-backdrop" tabindex="-1" *ngIf="showSuccessModal">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content custom-modal-content">
                <div class="modal-header custom-modal-header">
                  <h5 class="modal-title flex-grow-1 text-center">
                    Eliminación
                  </h5>
                  <button type="button" class="btn-close custom-btn-close" aria-label="Cerrar"
                    (click)="showSuccessModal = false">
                    <i class="bi bi-x-circle-fill"></i>
                  </button>
                </div>
                <div class="modal-body text-center custom-modal-body">
                  Eliminado correctamente.
                </div>
              </div>
            </div>
          </div>

          <!-- Modal de “¿Cómo lo has resuelto?” -->
          <div class="modal fade show d-block custom-modal-backdrop solucion-modal" tabindex="-1" *ngIf="mostrarModalSolucion"
            (click)="cerrarModalSolucion()">
            <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()">
              <div class="modal-content custom-modal-content">
                <div class="modal-header custom-modal-header">
                  <h5 class="modal-title flex-grow-1 text-center">¿Cómo lo has resuelto?</h5>
                  <button type="button" class="btn-close custom-btn-close" aria-label="Cerrar" (click)="cerrarModalSolucion()">
                    <i class="bi bi-x-circle-fill"></i>
                  </button>
                </div>
                <div class="modal-body custom-modal-body">
                  <!-- Textarea enlazado a la variable "resolucion" -->
                  <textarea [(ngModel)]="resolucion" placeholder="Escribe el motivo de la resolución..."
                    class="form-control"></textarea>
                </div>
                <div class="modal-footer border-0 justify-content-center">
                  <button type="button" class="btn btn-success me-2" (click)="enviarResolucion()">
                    <i class="bi bi-check-circle-fill me-1"></i> Enviar
                  </button>
                  <button type="button" class="btn btn-danger" (click)="cerrarModalSolucion()">
                    <i class="bi bi-x-circle-fill me-1"></i> Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</main>